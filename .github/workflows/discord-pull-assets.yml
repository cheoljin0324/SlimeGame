name: Discord â†’ GitHub (Polling Sync)

on:
  schedule:
    - cron: "*/5 * * * *"     # 5ë¶„ë§ˆë‹¤ ì‹¤í–‰
  workflow_dispatch: {}       # ìˆ˜ë™ ì‹¤í–‰ ë²„íŠ¼

permissions:
  contents: write

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: pip install requests

      # (ì„ íƒ) ìˆ˜ë™ ì‹¤í–‰ ì‹œ ì±„ë„ë¡œ í…ŒìŠ¤íŠ¸ ë©”ì‹œì§€ ë³´ë‚´ê¸°
      - name: Post smoke test to Discord
        if: ${{ github.event_name == 'workflow_dispatch' }}
        env:
          DISCORD_TOKEN: ${{ secrets.DISCORD_TOKEN }}
          # í•„ìš”í•˜ë©´ ì•„ë˜ ì±„ë„ IDë¥¼ íŠ¹ì • í…ìŠ¤íŠ¸ ì±„ë„ IDë¡œ ë°”ê¾¸ì„¸ìš”.
          CHANNEL: ${{ vars.DISCORD_SMOKE_TEST_CHANNEL || vars.DISCORD_CHANNEL_IDS }}
        run: |
          CH=$(echo "$CHANNEL" | cut -d',' -f1)  # ì²« ë²ˆì§¸ ì±„ë„ IDë§Œ ì‚¬ìš©
          curl -sS -X POST "https://discord.com/api/v10/channels/$CH/messages" \
            -H "Authorization: Bot $DISCORD_TOKEN" \
            -H "Content-Type: application/json" \
            -d '{"content":"ping from GitHub Actions âœ…"}' >/dev/null || true

      - name: Run poller
        env:
          DISCORD_TOKEN: ${{ secrets.DISCORD_TOKEN }}
          CHANNEL_IDS: ${{ vars.DISCORD_CHANNEL_IDS }}   # "123,456" í˜•ì‹
          SAVE_ROOT: Assets/Sprites/discord              # Unity í´ë”ë¡œ ì €ì¥
          STATE_FILE: .sync/discord_state.json
          MAX_LOOKBACK: "500"
          RECENT_WINDOW: "80"
          ALLOW_EXT: "png,jpg,jpeg,gif,webp,psd,clip,bmp,tiff,svg"
          ENABLE_HASH: "0"
          # ğŸ”” ì±„ë„ ì•ˆë‚´ ë©”ì‹œì§€ ì˜µì…˜
          POST_CONFIRM: "1"                              # ìƒˆ ì²¨ë¶€ ë™ê¸°í™” ì‹œ ì±„íŒ… ì „ì†¡
          POST_CHANNEL_ID: ""                            # ë¹„ìš°ë©´ ì›ë³¸ ì±„ë„ë¡œ ì „ì†¡; íŠ¹ì • ì±„ë„ IDë¡œ ê³ ì • ê°€ëŠ¥
          POST_MESSAGE_TEMPLATE: "ì´ë¯¸ì§€ ë„ˆë¬´ ìŒ“ì•„ë’€ì–ì•„ìš” ì„ ìƒë‹˜! ({count}ê°œ)\n{files}"
        run: |
          python .github/scripts/sync_discord_assets.py
          echo "Poll done."

      - name: Commit & push if changed
        run: |
          git config user.name "discord-sync-bot"
          git config user.email "actions@github.com"
          git add -A
          if git diff --cached --quiet; then
            echo "No changes."
          else
            git pull --rebase
            git commit -m "chore(assets): discord polling sync"
            git push
          fi
